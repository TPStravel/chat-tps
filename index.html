<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDReBGhb2gZNv7KA86HJXTeiLimWTrurp8",
    authDomain: "canal-vivo-chat.firebaseapp.com",
    projectId: "canal-vivo-chat"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const chat = document.getElementById('chat');
  let chatHistory = JSON.parse(localStorage.getItem('tps-chat-history')) || [];

  function scrollToBottom() {
    setTimeout(() => {
      chat.scrollTop = chat.scrollHeight;
    }, 50); // Pequeno atraso para garantir renderizaÃ§Ã£o
  }

  function addMessage(content, sender = 'user') {
    const message = document.createElement('div');
    message.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');
    message.innerHTML = `<span class="avatar">${sender === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–'}</span><span>${content}</span>`;
    chat.appendChild(message);

    // HistÃ³rico local
    chatHistory.push({ content, sender });
    localStorage.setItem('tps-chat-history', JSON.stringify(chatHistory));

    // Firebase
    db.collection('mensagens_tps').add({
      mensagem: content,
      remetente: sender,
      timestamp: new Date()
    });

    scrollToBottom();
  }

  async function sendMessage() {
    const input = document.getElementById('userInput');
    const text = input.value.trim();
    if (text === '') return;

    addMessage(text, 'user');
    input.value = '';

    const typing = document.createElement('div');
    typing.classList.add('message', 'bot-message');
    typing.innerHTML = `<span class="avatar">ðŸ¤–</span><span class="typing">Digitando...</span>`;
    chat.appendChild(typing);
    scrollToBottom();

    try {
      const res = await fetch('/api/gpt', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text })
      });
      const data = await res.json();
      typing.remove();
      addMessage(data.reply || 'Erro ao obter resposta.', 'bot');
    } catch (err) {
      typing.remove();
      addMessage('Erro ao conectar com o servidor.', 'bot');
    }
  }

  // InicializaÃ§Ã£o completa
  window.onload = () => {
    chatHistory.forEach(msg => addMessage(msg.content, msg.sender));

    // Ativa Enter corretamente
    const input = document.getElementById('userInput');
    input.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
      }
    });

    scrollToBottom();
  };
</script>
